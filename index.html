<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: var(--tg-theme-button-color, #4a8eff);
            --primary-hover: var(--tg-theme-button-color, #3a7bef);
            --text: var(--tg-theme-text-color, #2d3436);
            --bg: var(--tg-theme-bg-color, #f5f6f8);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #7f8c8d);
            --border: rgba(0, 0, 0, 0.08);
            --success: #4caf50;
            --warning: #ff9800;
            --radius: 14px;
            --shadow: 0 3px 12px rgba(0, 0, 0, 0.05);
            --transition: all 0.25s cubic-bezier(0.3, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            background-color: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 0 var(--border);
            backdrop-filter: blur(10px);
        }

        .container {
            padding: 16px;
            max-width: 100%;
            margin: 0 auto;
        }

        .ticket-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .status-badge.pending {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .status-badge.answered {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .ticket-id {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ticket-id::before {
            content: "üìå";
        }

        .ticket-text {
            font-size: 15px;
            line-height: 1.5;
            margin: 12px 0;
            white-space: pre-wrap;
        }

        .answer-card {
            background-color: rgba(74, 142, 255, 0.05);
            border-radius: 10px;
            padding: 14px;
            margin: 16px 0 8px;
            border-left: 3px solid var(--primary);
        }

        .answer-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .answer-title::before {
            content: "üí¨";
        }

        .answer-text {
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .ticket-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 14px;
            font-size: 13px;
            color: var(--hint);
        }

        .date {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            font-size: 18px;
        }

        .tickets-title::before {
            content: "üìã";
        }

        .new-ticket-title::before {
            content: "‚úèÔ∏è";
        }

        textarea {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background-color: var(--card-bg);
            margin-bottom: 16px;
            min-height: 120px;
            resize: none;
            font-family: inherit;
            font-size: 15px;
            transition: var(--transition);
            outline: none;
        }

        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 142, 255, 0.2);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--card-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--hint);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 15px;
            margin-bottom: 16px;
        }

        .skeleton {
            animation: skeleton-loading 1.5s infinite ease-in-out;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { opacity: 0.5; }
            50% { opacity: 0.8; }
            100% { opacity: 0.5; }
        }

        .divider {
            height: 1px;
            background-color: var(--border);
            margin: 24px 0;
        }

        .char-counter {
            text-align: right;
            font-size: 13px;
            color: var(--hint);
            margin-top: -12px;
            margin-bottom: 12px;
        }

        .char-counter.warning {
            color: var(--warning);
        }
    </style>
</head>
<body>
    <div class="header">–¶–µ–Ω—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
    <div class="container">
        <div class="section">
            <div class="section-title tickets-title">–í–∞—à–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</div>
            <div id="tickets-list">
                <div class="ticket-card">
                    <div class="skeleton" style="height: 20px; width: 80px; margin-bottom: 12px;"></div>
                    <div class="skeleton" style="height: 16px; width: 120px; margin-bottom: 16px;"></div>
                    <div class="skeleton" style="height: 14px; margin-bottom: 4px;"></div>
                    <div class="skeleton" style="height: 14px; width: 90%; margin-bottom: 4px;"></div>
                    <div class="skeleton" style="height: 14px; width: 70%; margin-bottom: 16px;"></div>
                    <div class="skeleton" style="height: 12px; width: 100px;"></div>
                </div>
            </div>
        </div>
        
        <div class="divider"></div>
        
        <div class="section">
            <div class="section-title new-ticket-title">–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</div>
            <textarea 
                id="ticket-text" 
                placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ...\n\n‚Ä¢ –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?\n‚Ä¢ –ö–æ–≥–¥–∞ —ç—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å?\n‚Ä¢ –ö–∞–∫–æ–≤ –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?"
                maxlength="1000"
                rows="5"></textarea>
            <div id="char-counter" class="char-counter">0/1000</div>
            <button class="btn" onclick="createTicket()">
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</span>
            </button>
        </div>
        
        <button class="btn btn-secondary" onclick="window.location.reload()">
            <span>üîÑ –û–±–Ω–æ–≤–∏—Ç—å</span>
        </button>
    </div>

    <script>
        const tg = Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            parseTicketsFromUrl();
            setupTextareaCounter();
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–º—É Telegram
            if (tg.colorScheme) {
                document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#f5f6f8');
                document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#2d3436');
            }
        });

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                day: 'numeric', 
                month: 'short', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return date.toLocaleString('ru-RU', options);
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ —Ç–∏–∫–µ—Ç–æ–≤
        function parseTicketsFromUrl() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const ticketsParam = urlParams.get('tickets');
                
                if (ticketsParam) {
                    setTimeout(() => {
                        const tickets = JSON.parse(ticketsParam);
                        displayTickets(tickets);
                    }, 300); // –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                } else {
                    showEmptyState();
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
                showErrorState();
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤
        function displayTickets(tickets) {
            const container = document.getElementById('tickets-list');
            
            if (!Array.isArray(tickets)) {
                showErrorState();
                return;
            }
            
            if (tickets.length === 0) {
                showEmptyState();
                return;
            }
            
            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card">
                    <div class="status-badge ${ticket.status}">
                        ${ticket.status === 'answered' ? '‚úÖ –†–µ—à–µ–Ω–æ' : 'üïí –í —Ä–∞–±–æ—Ç–µ'}
                    </div>
                    <div class="ticket-id">–ó–∞–ø—Ä–æ—Å #${ticket.id}</div>
                    <div class="ticket-text">${escapeHtml(ticket.text)}</div>
                    ${ticket.answer ? `
                    <div class="answer-card">
                        <div class="answer-title">–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
                        <div class="answer-text">${escapeHtml(ticket.answer)}</div>
                    </div>
                    ` : ''}
                    <div class="ticket-meta">
                        <div class="date">üìÖ ${formatDate(ticket.created_at)}</div>
                        ${ticket.status === 'answered' ? '<div class="status">‚úîÔ∏è –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω</div>' : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, "<br>");
        }
        
        // –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        function showEmptyState() {
            document.getElementById('tickets-list').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <div class="empty-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</div>
                    <button class="btn" onclick="document.getElementById('ticket-text').focus()">
                        <span>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</span>
                    </button>
                </div>
            `;
        }
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏
        function showErrorState() {
            document.getElementById('tickets-list').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                    <button class="btn btn-secondary" onclick="window.location.reload()">
                        <span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>
                    </button>
                </div>
            `;
        }
        
        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
        function setupTextareaCounter() {
            const textarea = document.getElementById('ticket-text');
            const counter = document.getElementById('char-counter');
            
            textarea.addEventListener('input', function() {
                const length = this.value.length;
                counter.textContent = `${length}/1000`;
                
                if (length > 900) {
                    counter.classList.add('warning');
                } else {
                    counter.classList.remove('warning');
                }
                
                if (length > 1000) {
                    this.value = this.value.substring(0, 1000);
                    tg.showAlert("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ - 1000 —Å–∏–º–≤–æ–ª–æ–≤");
                }
            });
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞
        function createTicket() {
            const text = document.getElementById('ticket-text').value.trim();
            
            if (!text) {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É");
                return;
            }
            
            if (text.length > 1000) {
                tg.showAlert("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ - 1000 —Å–∏–º–≤–æ–ª–æ–≤");
                return;
            }
            
            tg.MainButton.showProgress(true);
            tg.sendData(JSON.stringify({
                action: "create_ticket",
                text: text
            }));
            
            // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã
            document.getElementById('ticket-text').value = '';
            document.getElementById('char-counter').textContent = '0/1000';
            
            tg.showAlert("‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!", () => {
                tg.MainButton.hideProgress();
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        if (tg.platform !== 'unknown') {
            tg.BackButton.show();
            tg.BackButton.onClick(() => tg.close());
        }
    </script>
</body>
</html>
